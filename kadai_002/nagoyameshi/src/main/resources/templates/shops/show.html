<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <div th:replace="~{fragment :: meta}"></div>
    <div th:replace="~{fragment :: styles}"></div>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <title>NAGOYAMESHI | 店舗一覧</title>
</head>
<body>
<div class="nagoyameshi-wrapper">
    <div th:replace="~{fragment :: header}"></div>
	
	<main>
		<div class="container pt-4 pb-5 nagoyameshi-container">
			<div class="row justify-content-center">
			   <div class="col-xl-8 col-lg-8 col-md-12">
                       <nav class="mb-4" style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                           <ol class="breadcrumb mb-0">
							   <li class="breadcrumb-item"><a th:href="@{/}">ホーム</a></li>
                               <li class="breadcrumb-item"><a th:href="@{/shops}">店舗一覧</a></li>
                               <li class="breadcrumb-item active" aria-current="page">店舗詳細</li>
						   </ol>
                       </nav>
					   
					   <!-- 有料プラン向けの表示 -->
					   <div sec:authorize="hasRole('PREMIUM')" class="text-end me-2 mb-3">

					       <!-- お気に入り解除ボタン -->
					       <form th:if="${isFavorite != null and isFavorite}" method="post" th:action="@{/favorites/remove}" class="d-inline">
					           <input type="hidden" name="shopId" th:value="${shop.id}" />
					           <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
					           <button type="submit" class="btn btn-sm favorite-remove-btn">♥ お気に入り解除</button>
					       </form>

					       <!-- お気に入り追加ボタン -->
					       <form th:if="${isFavorite == null or !isFavorite}" method="post" th:action="@{/favorites/add}" class="d-inline">
					           <input type="hidden" name="shopId" th:value="${shop.id}" />
					           <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
					           <button type="submit" class="btn btn-sm favorite-add-btn">♡ お気に入り追加</button>
					       </form>

					   </div>

		  		 <h1 class="mb-4 text-center" th:text="${shop.name}"></h1>
		   

				   <div th:if="${successMessage}" class="alert alert-info">
				       <span th:text="${successMessage}"></span>
				   </div>                              
		   
				   <div th:if="${errorMessage}" class="alert alert-danger">
				       <span th:text="${errorMessage}"></span>
				   </div>

				   <div class="mb-3">
				     <img th:if="${shop.imageName}" th:src="@{/storage/__${shop.imageName}__}" class="w-100" alt="画像">
				     <img th:unless="${shop.imageName}" th:src="@{/images/noImage.png}" class="w-100" alt="NO IMAGE">
				   </div>

		   <!-- 画像の下に左右2カラム -->
		   <div class="row mb-4">
		       <!-- 左：店舗情報 -->
		       <div class="col-lg-8">
		           <div class="row pb-2 mb-2 border-bottom">
		               <div class="col-4">
		                   <span class="fw-bold">店舗名</span>
		               </div>
		               <div class="col">
		                   <span th:text="${shop.name}"></span>
		               </div>
		           </div>

		           <div class="row pb-2 mb-2 border-bottom">
		               <div class="col-4">
		                   <span class="fw-bold">説明</span>
		               </div>
		               <div class="col">
		                   <span class="nagoyameshi-pre-wrap" th:text="${shop.description}"></span>
		               </div>
		           </div>

		           <div class="row pb-2 mb-2 border-bottom">
		               <div class="col-4">
		                   <span class="fw-bold">カテゴリー</span>
		               </div>
		               <div class="col">
		                   <span class="nagoyameshi-pre-wrap" th:text="${shop.category.name}"></span>
		               </div>
		           </div>
				   
				   <div class="row pb-2 mb-2 border-bottom">
				       <div class="col-4">
				           <span class="fw-bold">定員</span>
				       </div>
				       <div class="col">
				           <span class="nagoyameshi-pre-wrap" th:text="${shop.capacity + '人'}"></span>
				       </div>
				   </div>

		           <div class="row pb-2 mb-2 border-bottom">
		               <div class="col-4">
		                   <span class="fw-bold">郵便番号</span>
		               </div>
		               <div class="col">
		                   <span th:text="${shop.postalCode}"></span>
		               </div>
		           </div>

		           <div class="row pb-2 mb-2 border-bottom">
		               <div class="col-4">
		                   <span class="fw-bold">住所</span>
		               </div>
		               <div class="col">
		                   <span th:text="${shop.address}"></span>
		               </div>
		           </div>

		           <div class="row pb-2 mb-2 border-bottom">
		               <div class="col-4">
		                   <span class="fw-bold">電話番号</span>
		               </div>
		               <div class="col">
		                   <span th:text="${shop.phoneNumber}"></span>
		               </div>
		           </div>

		           <div class="row pb-2 mb-2 border-bottom">
		               <div class="col-4">
		                   <span class="fw-bold">営業時間</span>
		               </div>
		               <div class="col">
		                   <span th:text="${#temporals.format(shop.openingTime, 'HH:mm') + ' ～ ' + #temporals.format(shop.closingTime, 'HH:mm')}"></span>
		               </div>
		           </div>

		           <div class="row pb-2 mb-2 border-bottom">
		               <div class="col-4">
		                   <span class="fw-bold">定休日</span>
		               </div>
		               <div class="col">
		                   <span th:text="${shop.regularHoliday}"></span>
		               </div>
		           </div>
		       </div>
			   
			   <!-- 未ログインユーザー向け -->
			   <div sec:authorize="isAnonymous()" class="col-lg-4 mt-4 mt-lg-0">
			     <div class="card shadow-sm anonymous-card">
			       <div class="card-body text-center">
			         <h5 class="card-title">
			           <i class="bi bi-calendar-check-fill me-2"></i>無料会員登録は<br>お済みですか？
			         </h5>
			         <p class="card-text mb-2">
			           さらに<strong>プレミアム会員</strong>になると、<br>特典がいっぱい！
			         </p>
			         <div class="d-grid gap-2 mt-3">
			           <a th:href="@{/login}" class="btn btn-login">ログイン</a>
			           <a th:href="@{/signup}" class="btn btn-register">新規登録</a>
			         </div>
			       </div>
			     </div>
			   </div>
			   
			   <!-- プレミアム会員向け -->
			   <div sec:authorize="hasRole('PREMIUM')" class="col-lg-4 px-0 ps-lg-4 mb-4">
			     <div class="card">
			       <div class="card-body">
			       <form method="post" th:action="@{/shops/{id}/reservations/create(id=${shop.id})}" th:object="${reservationInputForm}">
			           <!-- 日時選択 -->
			           <div class="form-group mb-2">
			             <label for="reservationDateTimePicker" class="col-form-label text-md-left fw-bold">予約日時</label>

			             <div th:if="${#fields.hasErrors('reservationDate')}" class="text-danger small mb-2" th:errors="*{reservationDate}"></div>
			             <div th:if="${#fields.hasErrors('reservationTime')}" class="text-danger small mb-2" th:errors="*{reservationTime}"></div>

			             <input type="text" id="reservationDateTimePicker" class="form-control" placeholder="日付と時間を選択" th:value="${previousDates}" readonly>
			             <input type="hidden" name="reservationDate" th:field="*{reservationDate}">
			             <input type="hidden" name="reservationTime" th:field="*{reservationTime}">
			           </div>

			           <!-- 人数入力 -->
			           <div class="form-group mb-4">
			             <label for="numberOfPeople" class="col-form-label text-md-left fw-bold">予約人数</label>
			             <div th:if="${#fields.hasErrors('numberOfPeople')}" class="text-danger small mb-2" th:errors="*{numberOfPeople}"></div>
			             <input type="number" class="form-control" th:field="*{numberOfPeople}" min="1">
			           </div>

			           <!-- 送信ボタン -->
			           <div class="form-group">
			             <button type="submit" class="btn shadow-sm w-100 nagoyameshi-btn">予約する</button>
			           </div>
			         </form>
			       </div>
			     </div>
			   </div>

			   <!-- 一般会員（プレミアムではない）向け -->
			   <div sec:authorize="isAuthenticated() and !hasRole('PREMIUM')" class="col-lg-4 px-0 ps-lg-4 mb-4">
			     <div class="card shadow-sm anonymous-card">
			       <div class="card-body text-center">
			         <h5 class="card-title">
			           <i class="bi bi-lock-fill me-2"></i>有料プランへの<br>登録をおすすめします
			         </h5>
			         <p class="card-text mb-2">
			           <strong>月額300円</strong>でネット予約などの特典が利用できます！
			         </p>
			         <div class="d-grid gap-2 mt-3">
			           <a th:href="@{/subscription/plan}" class="btn btn-register">有料プランについて</a>
			         </div>
			       </div>
			     </div>
			   </div>										   
		   </div>
		   
		   <!-- レビューセクション -->
		   <div class="shop-review-wrapper">
		     <h2 class="mb-4 text-center">レビュー</h2>

			 <!-- ゲスト（未ログイン）向け -->
			 <div sec:authorize="isAnonymous()">
			     <div th:if="${#lists.isEmpty(guestReviews)}" class="mb-4">
			         <p class="text-center">まだレビューがありません。</p>
			     </div>

			     <div th:unless="${#lists.isEmpty(guestReviews)}" class="row row-cols-1 row-cols-md-2 g-4 mb-4">
			         <div th:each="review : ${guestReviews}" class="col">
			             <div class="card h-100 shadow-sm">
			                 <div class="card-body">
			                     <h5 class="card-title mb-2" th:text="${review.user.name}"></h5>
			                     <p class="card-text mb-1">
			                         <span class="nagoyameshi-star"
			                               th:each="star : ${#numbers.sequence(1, 5)}"
			                               th:utext="${star <= review.rating} ? '&#9733;' : '&#9734;'"></span>
			                     </p>
			                     <p class="card-text">
			                         <small class="text-muted" th:text="${#dates.format(review.createdAt, 'yyyy年MM月dd日')}"></small>
			                     </p>
			                     <p class="card-text" th:text="${review.comment}"></p>
			                 </div>
			             </div>
			         </div>
			     </div>

			 </div>

		       <!-- ログイン済ユーザー向け -->
		       <div sec:authorize="isAuthenticated()">
		           <div th:if="${#lists.isEmpty(newReviews)}" class="mb-4">
		               <p class="text-center">まだレビューがありません。</p>
		           </div>
				   <div th:unless="${#lists.isEmpty(newReviews)}" class="row row-cols-1 row-cols-md-2 g-4 mb-4">
				       <div th:each="review : ${newReviews}" class="col">
				           <div class="card h-100 shadow-sm">
				               <div class="card-body">
				                   <div class="d-flex justify-content-between align-items-center mb-2">
				                       <h5 class="card-title mb-0" th:text="${review.user.name}"></h5>
									   
									   <!-- 投稿者本人かつPREMIUMロールのみ編集・削除を表示 -->
									   <div th:if="${#authentication.principal.user.id == review.user.id}" sec:authorize="hasRole('PREMIUM')">
				                           <a th:href="@{/shops/__${shop.id}__/reviews/__${review.id}__/edit}" class="btn btn-sm btn-outline-primary me-1">編集</a>
				                           <a href="#" class="btn btn-sm btn-outline-danger"
				                              data-bs-toggle="modal" th:attr="data-bs-target=${'#deleteReviewModal' + review.id}">削除</a>
				                       </div>
				                   </div>

				                   <p class="card-text mb-1">
				                       <span class="nagoyameshi-star"
				                             th:each="star : ${#numbers.sequence(1, 5)}"
				                             th:utext="${star <= review.rating} ? '&#9733;' : '&#9734;'"></span>
				                   </p>
				                   <p class="card-text">
				                       <small class="text-muted" th:text="${#dates.format(review.createdAt, 'yyyy年MM月dd日')}"></small>
				                   </p>
				                   <p class="card-text" th:text="${review.comment}"></p>
				               </div>
				           </div>

				           <!-- 削除モーダル -->
				           <div class="modal fade" th:id="${'deleteReviewModal' + review.id}" tabindex="-1"
				                th:attr="aria-labelledby=${'deleteReviewModalLabel' + review.id}" aria-hidden="true">
				               <div class="modal-dialog">
				                   <div class="modal-content">
				                       <div class="modal-header">
				                           <h5 class="modal-title" th:id="${'deleteReviewModalLabel' + review.id}">
				                               レビューを削除してもよろしいですか？
				                           </h5>
				                           <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
				                       </div>
				                       <div class="modal-footer">
				                           <form method="post" th:action="@{/shops/__${shop.id}__/reviews/__${review.id}__/delete}">
				                               <button type="submit" class="btn btn-danger">削除</button>
				                           </form>
				                       </div>
				                   </div>
				               </div>
				           </div>
				       </div>
				   </div>

				   <div class="text-center mb-4" th:if="${totalReviewCount > 6}" sec:authorize="hasRole('PREMIUM')">
				       <a th:href="@{/shops/__${shop.id}__/reviews}">すべてのレビューを見る</a>
				   </div>
				   
					<!--ゲスト（未ログイン）ユーザー向け誘導-->
					<div class="text-center mb-4" th:if="${totalReviewCount > 6}" sec:authorize="isAnonymous()">
					  <div class="alert alert-light border anonymous-card">
					    <p class="mb-1">
					      すべてのレビューを見るには <strong>ログイン</strong> と <strong>有料プランの登録</strong> が必要です。
					    </p>
					    <div class="d-flex justify-content-center gap-2 mt-2">
					      <a th:href="@{/login}" class="btn btn-login">ログイン</a>
					      <a th:href="@{/signup}" class="btn btn-register">新規登録</a>
					    </div>
					  </div>
					</div>
				   <!--ゲスト（未ログイン）ユーザー向け誘導-->
				   <div class="text-center mb-4" th:if="${totalReviewCount > 6}" sec:authorize="isAuthenticated() and !hasRole('PREMIUM')">
				     <div class="alert alert-light border anonymous-card">
				       <p class="mb-1">
				         すべてのレビューを見るには <strong>有料プランの登録</strong> が必要です。
				       </p>
				       <a th:href="@{/subscription/plan}" class="btn btn-register mt-2">有料プランを見る</a>
				     </div>
				   </div>
				   
			       </div>
			   
				     <!-- 投稿ボタン -->
					 <div sec:authorize="hasRole('PREMIUM')" th:unless="${hasUserAlreadyReviewed}" class="row justify-content-center mb-4">
				         <div class="col-lg-4">
				             <a th:href="@{/shops/__${shop.id}__/reviews/register}" class="btn shadow-sm w-100 nagoyameshi-btn">レビューを投稿する</a>
				         </div>
				     </div>
				 
			   </div> <!-- /.shop-review-wrapper -->

	  				 </div> <!-- .row justify-content-center -->
	  			 </div> <!-- .col-xl-8 col-lg-8 col-md-12 -->
	 	  	</div> <!-- container -->
	   </main>
			
			<div th:replace="~{fragment :: footer}"></div>
			
			</div><!-- nagoyameshi-wrapper -->
			
			<div th:replace="~{fragment :: scripts}"></div>
			
			<!-- Flatpickr -->
			<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
			<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
			<script th:src="@{/js/flatpickr.js}"></script>
   </body>
</html>