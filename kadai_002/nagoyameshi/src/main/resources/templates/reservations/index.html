<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
   <head>
	<div th:replace="~{fragment :: meta}"></div>
	<div th:replace="~{fragment :: styles}"></div>
       <title>NAGOYAMESHI | 予約一覧</title>	
   </head>
   <body>
        <div class="nagoyameshi-wrapper">
			<div th:replace="~{fragment :: header}"></div>
			
			<main>
			              <div class="container pt-4 pb-5 nagoyameshi-container">
			                  <div class="row justify-content-center">
			                      <div class="col-xxl-9 col-xl-10 col-lg-11">
			                          
			                          <h1 class="mb-4 text-center">予約一覧</h1> 
									  
									  <nav class="my-3" style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
									      <ol class="breadcrumb mb-0">
									          <li class="breadcrumb-item"><a th:href="@{/}">ホーム</a></li>
									          <li class="breadcrumb-item active" aria-current="page">予約一覧</li>
									      </ol>
									  </nav>  
			                          
									  <!-- メッセージ表示 -->
									  <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

									  <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>

									  <!-- fallback的に param.reserved を表示 -->
									  <div th:if="${param.reserved} and ${successMessage} == null" class="alert alert-info">
									      予約が完了しました。
									  </div>                                                        
			                          
									  <!-- 予約一覧テーブル（修正済み） -->
									  <table class="table">
									    <thead>
									      <tr>
									        <th scope="col">店舗名</th>
									        <th scope="col">予約日</th>
									        <th scope="col">予約時間</th>
									        <th scope="col">予約人数</th>
									        <th scope="col" class="text-center">キャンセル</th>
									      </tr>
									    </thead>
									    <tbody>
									      <tr th:each="reservation : ${reservations}">
									        <td>
									          <a th:href="@{/shops/__${reservation.shop.id}__}" th:text="${reservation.shop.name}"></a>
									        </td>
									        <td th:text="${reservation.reservationDate}"></td>
									        <td th:text="${reservation.reservationTime}"></td>
									        <td th:text="${reservation.numberOfPeople + '名'}"></td>
									        <td class="text-center">
									          <button class="btn btn-outline-danger btn-sm"
									                  data-bs-toggle="modal"
									                  th:data-bs-target="${'#cancelModal' + reservation.id}">
									            キャンセル
									          </button>
									        </td>
									      </tr>
									    </tbody>
									  </table>
									  
									  <!-- 削除確認モーダル -->
									  <div th:each="reservation : ${reservations}">
									    <div class="modal fade" th:id="${'cancelModal' + reservation.id}" tabindex="-1">
									      <div class="modal-dialog">
									        <div class="modal-content">
									          <form th:action="@{/reservations/{id}/delete(id=${reservation.id})}" method="post">
									            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
									            <div class="modal-header">
									              <h5 class="modal-title">キャンセル確認</h5>
									              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
									            </div>
									            <div class="modal-body">
									              <p th:text="'『' + ${reservation.shop.name} + '』の予約をキャンセルしますか？'"></p>
									              <p th:text="'予約日時：' + ${reservation.reservationDate + ' ' + reservation.reservationTime}"></p>
									            </div>
									            <div class="modal-footer">
									              <button type="submit" class="btn btn-danger">キャンセルする</button>
									              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">戻る</button>
									            </div>
									          </form>
									        </div>
									      </div>
									    </div>
									  </div>
									
									  <!-- ページネーション -->
									   <div th:if="${reservationPage.getTotalPages() > 1}" class="d-flex justify-content-center">
									       <nav aria-label="予約一覧ページ">
									           <ul class="pagination">
									               <li class="page-item">
									                   <span th:if="${reservationPage.isFirst()}" class="page-link disabled">前</span>
									                   <a th:unless="${reservationPage.isFirst()}" th:href="@{/reservations(page = ${reservationPage.getNumber() - 1})}" class="page-link nagoyameshi-page-link">前</a>
									               </li>
									               <li th:each="i : ${#numbers.sequence(0, reservationPage.getTotalPages() - 1)}" class="page-item">
									                   <span th:if="${i == reservationPage.getNumber()}" class="page-link active nagoyameshi-active" th:text="${i + 1}"></span>
									                   <a th:unless="${i == reservationPage.getNumber()}" th:href="@{/reservations(page = ${i})}" class="page-link nagoyameshi-page-link" th:text="${i + 1}"></a>
									               </li>
									               <li class="page-item">
									                   <span th:if="${reservationPage.isLast()}" class="page-link disabled">次</span>
									                   <a th:unless="${reservationPage.isLast()}" th:href="@{/reservations(page = ${reservationPage.getNumber() + 1})}" class="page-link nagoyameshi-page-link">次</a>
									               </li>
									           </ul>
									       </nav>
									   </div> 
								                                        
			                      </div>
			                  </div>
			              </div>              
			          </main>
			
			<div th:replace="~{fragment :: footer}"></div>
		</div>
			<div th:replace="~{fragment :: scripts}"></div>
   </body>
</html>